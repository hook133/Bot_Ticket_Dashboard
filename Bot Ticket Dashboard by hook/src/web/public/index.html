<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #0f172a;
        color: #fff;
        margin: 0;
        padding: 0;
      }
      .toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        margin: -12px -12px 16px -12px;
        background: rgba(30, 27, 75, 0.9);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid #312e81;
      }
      .toolbar .actions { display: flex; gap: 8px; }
      .muted { color: #94a3b8; font-size: 14px; }
      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 16px;
      }
      .card { background:#111827; border:1px solid #4338ca; border-radius:12px; padding:16px; }
      .span-8 { grid-column: span 8; }
      .span-4 { grid-column: span 4; }
      .option-actions { display:flex; gap:8px; margin-top:8px; }
      .btn-secondary { background:#334155; }
      .btn-danger { background:#ef4444; }
      header {
        padding: 24px;
        background: #1e293b;
        text-align: center;
        border-bottom: 1px solid #334155;
      }
      main {
        max-width: 960px;
        margin: 24px auto;
        background: #1e1b4b;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.8);
      }
      section {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #312e81;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #4338ca;
        background: #0f172a;
        color: #fff;
        margin-bottom: 12px;
      }
      button {
        padding: 12px 16px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(120deg, #6366f1, #8b5cf6);
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      button:hover {
        transform: translateY(-2px);
      }
      .flex {
        display: flex;
        gap: 16px;
      }
      .flex > div {
        flex: 1;
      }
      .menu-item {
        background: #111827;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 12px;
        border: 1px solid #4338ca;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</h1>
      <p id="credit" class="muted" style="margin-top:6px"></p>
    </header>
    <main>
      <div class="toolbar">
        <div class="muted">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        <div style="flex:1;text-align:center"><span id="devBadge" class="muted" dir="ltr"></span></div>
        <div class="actions">
          <button id="toolbarSave" class="btn-secondary">Ø­ÙØ¸</button>
          <button id="toolbarPublish">Ù†Ø´Ø±</button>
        </div>
      </div>
      <section>
        <label for="guildSelect">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ±ÙØ±</label>
        <select id="guildSelect"></select>
        <div class="flex">
          <button id="fetchPanel">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button id="publishPanel">Ù†Ø´Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</button>
        </div>
      </section>

      <section>
        <div class="grid">
          <div class="span-8 card">
            <label for="channelId">Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙŠ ÙŠÙØ±Ø³Ù„ ÙÙŠÙ‡Ø§ Ø§Ù„Ù„ÙˆØ­Ø©</label>
            <select id="channelId"></select>
            <label for="ticketCategoryId" style="margin-top:8px">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø°ÙŠ ØªÙÙ†Ø´Ø£ ÙÙŠÙ‡ Ø§Ù„ØªØ°Ø§ÙƒØ±</label>
            <select id="ticketCategoryId">
              <option value="">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>
            </select>
            <label for="selectPlaceholder" style="margin-top:8px">Ù†Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Placeholder) Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
            <input id="selectPlaceholder" placeholder="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø©" />
            <div class="card" style="margin-top:8px">
              <label for="claimLogChannelId">Ù‚Ù†Ø§Ø© Ù„ÙˆØ¬ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="claimLogChannelId">
                <option value="">Ø¨Ø¯ÙˆÙ†</option>
              </select>
              <label for="closeLogChannelId">Ù‚Ù†Ø§Ø© Ù„ÙˆØ¬ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="closeLogChannelId">
                <option value="">Ø¨Ø¯ÙˆÙ†</option>
              </select>
              <div class="flex" style="margin-top:8px; align-items:center">
                <div style="flex:2">
                  <label for="resetUserId">ØªØµÙÙŠØ± Ù„Ø¹Ø¶Ùˆ Ù…Ø­Ø¯Ø¯ (User ID) Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                  <input id="resetUserId" placeholder="123456789012345678" />
                </div>
                <button id="resetStats" style="width:auto;height:38px;margin-inline-start:8px">ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
              </div>
              <div style="margin-top:12px">
                <div class="flex" style="justify-content: space-between; align-items:center">
                  <h3 class="muted">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h3>
                  <button id="refreshStats" class="btn-secondary" style="width:auto">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                </div>
                <div style="overflow:auto">
                  <table id="statsTable" style="width:100%; border-collapse: collapse; margin-top:8px">
                    <thead>
                      <tr>
                        <th style="text-align:right; padding:6px; border-bottom:1px solid #312e81">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th style="text-align:right; padding:6px; border-bottom:1px solid #312e81">ID</th>
                        <th style="text-align:right; padding:6px; border-bottom:1px solid #312e81">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="span-4 card">
            <label for="staffRoles">Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø·Ø§Ù‚Ù…</label>
            <div class="flex" style="align-items: flex-end">
              <div style="flex: 2">
                <select id="availableRoles"></select>
              </div>
              <button type="button" id="addRole" style="flex: 1">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ÙˆÙ„</button>
            </div>
            <ul id="staffRoles" style="list-style:none;padding:0;margin-top:12px"></ul>
          </div>
        </div>
      </section>

      <section>
        <div class="grid">
          <div class="span-8 card">
            <label for="embedTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ Embed</label>
            <input id="embedTitle" placeholder="ğŸŸï¸ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ" />
            <label for="embedDescription">ÙˆØµÙ Ø§Ù„Ù€ Embed (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ­Ø©)</label>
            <textarea id="embedDescription" rows="4" placeholder="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©"></textarea>
            <label for="ticketMessage">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© (ØªØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙŠÙƒØª)</label>
            <textarea id="ticketMessage" rows="3" placeholder="ÙŠØ±Ø¬Ù‰ ÙˆØµÙ Ù…Ø´ÙƒÙ„ØªÙƒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§."></textarea>
          </div>
          <div class="span-4 card">
            <label for="embedColor">Ù„ÙˆÙ† Ø§Ù„Ù€ Embed</label>
            <div class="flex" style="align-items:center">
              <input id="embedColor" type="color" value="#5865f2" style="flex:0" />
              <div id="colorPreview" style="flex:1;height:36px;border-radius:8px;border:1px solid #4338ca;margin-inline-start:8px;display:flex;align-items:center;justify-content:center;">
                <span id="colorPreviewText" class="muted"></span>
              </div>
            </div>
            <button id="applyColor" style="margin-top:8px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ÙˆÙ†</button>
            <label for="embedImageUrl">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù€ Embed (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="embedImageUrl" placeholder="https://.../image.png" />
          </div>
        </div>
      </section>

      <section>
        <div class="flex" style="align-items: center; justify-content: space-between">
          <h2>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© <span id="menuCount" class="muted"></span></h2>
          <div class="actions">
            <button id="addMenuOption" style="width: auto">Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±</button>
          </div>
        </div>
        <div id="menuOptions"></div>
      </section>

      <section>
        <button id="savePanel">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </section>
    </main>

    <script>
      const guildSelect = document.getElementById('guildSelect');
      const channelSelect = document.getElementById('channelId');
      const ticketCategorySelect = document.getElementById('ticketCategoryId');
      const availableRolesSelect = document.getElementById('availableRoles');
      const staffRolesList = document.getElementById('staffRoles');
      const embedTitleInput = document.getElementById('embedTitle');
      const embedDescriptionInput = document.getElementById('embedDescription');
      const embedColorInput = document.getElementById('embedColor');
      const colorPreview = document.getElementById('colorPreview');
      const colorPreviewText = document.getElementById('colorPreviewText');
      const embedImageUrlInput = document.getElementById('embedImageUrl');
      const ticketMessageInput = document.getElementById('ticketMessage');
      const selectPlaceholderInput = document.getElementById('selectPlaceholder');
      const claimLogChannelSelect = document.getElementById('claimLogChannelId');
      const closeLogChannelSelect = document.getElementById('closeLogChannelId');
      const menuContainer = document.getElementById('menuOptions');
      const resetUserIdInput = document.getElementById('resetUserId');
      const statsTable = document.getElementById('statsTable');

      document.getElementById('fetchPanel').addEventListener('click', async () => {
        await fetchResources();
        await fetchPanel();
      });

      document.getElementById('savePanel').addEventListener('click', savePanel);
      document.getElementById('publishPanel').addEventListener('click', publishPanel);
      document.getElementById('toolbarSave').addEventListener('click', savePanel);
      document.getElementById('toolbarPublish').addEventListener('click', publishPanel);
      document.getElementById('addMenuOption').addEventListener('click', () => addMenuOption());
      document.getElementById('addRole').addEventListener('click', addRoleToList);
      document.getElementById('applyColor').addEventListener('click', savePanel);
      document.getElementById('resetStats').addEventListener('click', resetStats);
      document.getElementById('refreshStats').addEventListener('click', loadStats);

      function updateColorPreview() {
        const hex = embedColorInput.value || '#5865f2';
        colorPreview.style.background = hex;
        colorPreviewText.textContent = hex.toUpperCase();
      }
      embedColorInput.addEventListener('input', updateColorPreview);

      function createMenuDom(option = { label: '', description: '' }) {
        const wrapper = document.createElement('div');
        wrapper.className = 'menu-item';
        wrapper.innerHTML = `
          <div class="flex" style="gap:12px">
            <div style="flex:2">
              <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <input value="${option.label}" class="menu-label" />
            </div>
          </div>
          <label>Ø§Ù„ÙˆØµÙ</label>
          <input value="${option.description}" class="menu-description" />
          <div class="option-actions">
            <button type="button" class="up btn-secondary">â–² Ù„Ø£Ø¹Ù„Ù‰</button>
            <button type="button" class="down btn-secondary">â–¼ Ù„Ø£Ø³ÙÙ„</button>
            <button type="button" class="dup btn-secondary">Ù†Ø³Ø®</button>
            <button type="button" class="remove btn-danger">Ø­Ø°Ù</button>
          </div>
        `;
        wrapper.querySelector('.remove').addEventListener('click', () => { wrapper.remove(); updateMenuCount(); });
        wrapper.querySelector('.up').addEventListener('click', () => moveOption(wrapper, -1));
        wrapper.querySelector('.down').addEventListener('click', () => moveOption(wrapper, 1));
        wrapper.querySelector('.dup').addEventListener('click', () => duplicateOption(wrapper));
        menuContainer.appendChild(wrapper);
        updateMenuCount();
      }

      function addMenuOption(option) {
        createMenuDom({ label: option?.label || '', description: option?.description || '' });
      }

      function updateMenuCount() {
        const count = menuContainer.querySelectorAll('.menu-item').length;
        const el = document.getElementById('menuCount');
        if (el) el.textContent = `(${count}/25)`;
      }

      function moveOption(wrapper, delta) {
        const items = [...menuContainer.querySelectorAll('.menu-item')];
        const idx = items.indexOf(wrapper);
        const target = idx + delta;
        if (target < 0 || target >= items.length) return;
        if (delta < 0) menuContainer.insertBefore(wrapper, items[target]);
        else menuContainer.insertBefore(items[target], wrapper);
      }

      function duplicateOption(wrapper) {
        const label = wrapper.querySelector('.menu-label').value;
        const description = wrapper.querySelector('.menu-description').value;
        createMenuDom({ label, description });
      }

      function addRoleChip(roleId) {
        if (!roleId) return;
        const exists = !![...staffRolesList.querySelectorAll('li')].find(
          (li) => li.dataset.id === roleId
        );
        if (exists) return;
        const li = document.createElement('li');
        li.dataset.id = roleId;
        li.style.display = 'inline-flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.border = '1px solid #4338ca';
        li.style.padding = '6px 10px';
        li.style.borderRadius = '999px';
        li.style.margin = '4px';
        const opt = [...availableRolesSelect.options].find((o) => o.value === roleId);
        li.textContent = opt ? opt.textContent : roleId;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = 'Ø¥Ø²Ø§Ù„Ø©';
        btn.style.marginInlineStart = '8px';
        btn.addEventListener('click', () => li.remove());
        li.appendChild(btn);
        staffRolesList.appendChild(li);
      }

      function addRoleToList() {
        const roleId = availableRolesSelect.value;
        if (!roleId) return;
        addRoleChip(roleId);
      }

      function collectRoleIds() {
        return [...staffRolesList.querySelectorAll('li')].map((li) => li.dataset.id);
      }

      function collectMenuOptions() {
        return [...menuContainer.querySelectorAll('.menu-item')].map((item) => ({
          label: item.querySelector('.menu-label').value,
          description: item.querySelector('.menu-description').value
        }));
      }

      async function fetchResources() {
        const guildId = guildSelect.value;
        if (!guildId) return alert('Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„Ø§Ù‹');
        const res = await fetch(`/api/guilds/${guildId}/resources`, { cache: 'no-store' });
        if (!res.ok) return alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª/Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª/Ø§Ù„Ø£Ø¯ÙˆØ§Ø±');
        const data = await res.json();
        const channelOptionsHtml = data.channels
          .map((ch) => `<option value="${ch.id}">${ch.name}</option>`)
          .join('');
        channelSelect.innerHTML = channelOptionsHtml;
        claimLogChannelSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ†</option>' + channelOptionsHtml;
        closeLogChannelSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ†</option>' + channelOptionsHtml;
        ticketCategorySelect.innerHTML =
          '<option value="">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>' +
          data.categories.map((cat) => `<option value="${cat.id}">${cat.name}</option>`).join('');
        availableRolesSelect.innerHTML = data.roles
          .map((role) => `<option value="${role.id}">${role.name}</option>`)
          .join('');
      }

      async function fetchPanel() {
        const guildId = guildSelect.value;
        if (!guildId) return;
        const res = await fetch(`/api/guilds/${guildId}/panel`, { cache: 'no-store' });
        if (!res.ok) return alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        const panel = await res.json();
        if (!panel) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯');
        channelSelect.value = panel.channelId;
        ticketCategorySelect.value = panel.ticketCategoryId ?? '';
        staffRolesList.innerHTML = '';
        (panel.staffRoleIds ?? []).forEach(addRoleChip);
        embedTitleInput.value = panel.embedTitle;
        embedDescriptionInput.value = panel.embedDescription;
        embedColorInput.value = `#${(panel.embedColor ?? 0).toString(16).padStart(6, '0')}`;
        updateColorPreview();
        embedImageUrlInput.value = panel.embedImageUrl || '';
        ticketMessageInput.value = panel.ticketMessage || '';
        selectPlaceholderInput.value = panel.selectPlaceholder || '';
        claimLogChannelSelect.value = panel.claimLogChannelId || '';
        closeLogChannelSelect.value = panel.closeLogChannelId || '';
        menuContainer.innerHTML = '';
        panel.menuOptions.forEach(addMenuOption);
      }

      function slugify(text) {
        return (text || '')
          .toString()
          .trim()
          .toLowerCase()
          .replace(/[^\p{L}\p{N}]+/gu, '_')
          .replace(/^_+|_+$/g, '')
          .slice(0, 50) || 'option';
      }

      function sanitizeMenuOptions(options) {
        let normalized = options
          .map((o) => ({
            label: (o.label || '').trim(),
            value: (o.value || '').trim(),
            description: (o.description || '').trim().slice(0, 100)
          }))
          .filter((o) => o.label);

        normalized = normalized.map((o) => ({
          ...o,
          value: o.value || slugify(o.label)
        }));

        const seen = new Map();
        normalized = normalized.map((o) => {
          let base = o.value;
          if (!base) base = slugify(o.label);
          let candidate = base;
          let i = 2;
          while (seen.has(candidate)) {
            candidate = `${base}-${i++}`;
          }
          seen.set(candidate, true);
          return { ...o, value: candidate };
        });

        return normalized;
      }

      async function savePanel() {
        const guildId = guildSelect.value;
        if (!guildId) return alert('Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø³ÙŠØ±ÙØ±');
        const rawMenuOptions = collectMenuOptions();
        const menuOptions = sanitizeMenuOptions(rawMenuOptions);
        if (menuOptions.length === 0) {
          return alert('Ø£Ø¶Ù Ø®ÙŠØ§Ø±Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ¨Ø­ÙŠØ« ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©');
        }
        const values = menuOptions.map((o) => o.value);
        const hasDup = new Set(values).size !== values.length;
        if (hasDup) {
          return alert('ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ… Ù…ÙƒØ±Ø±Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸Ù‡Ø§. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
        const payload = {
          channelId: channelSelect.value,
          ticketCategoryId: ticketCategorySelect.value || undefined,
          staffRoleIds: collectRoleIds(),
          embedTitle: embedTitleInput.value,
          embedDescription: embedDescriptionInput.value,
          embedColor: embedColorInput.value,
          embedImageUrl: embedImageUrlInput.value,
          ticketMessage: ticketMessageInput.value,
          selectPlaceholder: selectPlaceholderInput.value,
          claimLogChannelId: claimLogChannelSelect.value || undefined,
          closeLogChannelId: closeLogChannelSelect.value || undefined,
          menuOptions
        };
        const res = await fetch(`/api/guilds/${guildId}/panel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const data = await res.json();
          return alert(data.message || 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        }
        await fetchPanel();
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
      }

      async function publishPanel() {
        const guildId = guildSelect.value;
        if (!guildId) return alert('Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø³ÙŠØ±ÙØ±');
        const res = await fetch(`/api/guilds/${guildId}/panel/publish`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return alert(data.message || 'ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø´Ø±');
        alert('ØªÙ… Ù†Ø´Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ°Ø§ÙƒØ± ÙÙŠ Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯');
      }

      async function resetStats() {
        const guildId = guildSelect.value;
        if (!guildId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„Ø§Ù‹');
        const userId = (resetUserIdInput.value || '').trim();
        const res = await fetch(`/api/guilds/${guildId}/stats/reset`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userId ? { userId } : {})
        });
        if (!res.ok) {
          const data = await res.json();
          return alert(data.message || 'ØªØ¹Ø°Ø± ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
        }
        alert('ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        await loadStats();
      }

      async function loadStats() {
        const guildId = guildSelect.value;
        if (!guildId) return;
        const res = await fetch(`/api/guilds/${guildId}/stats/top?limit=20`, { cache: 'no-store' });
        if (!res.ok) return;
        const rows = (await res.json()) || [];
        const tbody = statsTable.querySelector('tbody');
        const nonZero = rows.filter((r) => (r.claimedCount || 0) > 0);
        if (!nonZero.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" class="muted" style="padding:10px; text-align:center; border-bottom:1px solid #1f2442">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</td>
            </tr>`;
        } else {
          tbody.innerHTML = nonZero
            .map(
              (r) => `
              <tr>
                <td style="padding:6px; border-bottom:1px solid #1f2442">${r.displayName || r.userId}</td>
                <td style="padding:6px; border-bottom:1px solid #1f2442">${r.userId}</td>
                <td style="padding:6px; border-bottom:1px solid #1f2442">${r.claimedCount}</td>
              </tr>`
            )
            .join('');
        }
      }

      async function loadGuilds() {
        const res = await fetch('/api/guilds', { cache: 'no-store' });
        if (!res.ok) return;
        const guilds = await res.json();
        guildSelect.innerHTML = guilds.map((g) => `<option value="${g.id}">${g.name}</option>`).join('');
      }

      (async () => {
        await loadGuilds();
        if (guildSelect.value) {
          await fetchResources();
          await fetchPanel();
        }
        updateColorPreview();
        await loadStats();
        try {
          const credit = document.getElementById('credit');
          const nums = [72,115,115,39,121,112,110,111,123,122,39,121,108,122,108,121,125,108,107,39,123,118,39,79,86,86,82];
          const text = String.fromCharCode(...nums.map((n)=>n-7));
          credit.textContent = text;
        } catch {}
        try {
          const badge = document.getElementById('devBadge');
          const nums2 = [90,120,106,119,37,73,106,123,37,63,37,108,56,102,51];
          const text2 = String.fromCharCode(...nums2.map((n)=>n-5));
          badge.textContent = text2;
        } catch {}
      })();
    </script>
  </body>
</html>
